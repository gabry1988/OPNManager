name: Build Android APK (No-Actions Safe)

on:
  push:
    tags: ['v*']
  workflow_dispatch: {}

permissions:
  contents: write

env:
  ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
  ANDROID_HOME: /usr/local/lib/android/sdk
  NDK_HOME: /usr/local/lib/android/sdk/ndk/25.2.9519653
  TAURI_SKIP_DEVSERVER: true
  CARGO_TERM_COLOR: always

jobs:
  build-android:
    runs-on: ubuntu-latest
    steps:
      - name: 🧰 Base tools
        run: |
          set -euxo pipefail
          sudo apt-get update
          sudo apt-get install -y git tar curl unzip zip xz-utils build-essential pkg-config openjdk-17-jdk
          git --version
          tar --version
          java -version

      - name: 📥 Clone repository (manual)
        run: |
          set -euxo pipefail
          git clone "https://github.com/${GITHUB_REPOSITORY}.git" .
          git fetch --all --tags --force
          if [[ "${GITHUB_REF:-}" == refs/tags/* ]]; then
            git checkout -f "${GITHUB_REF_NAME}"
          else
            git checkout -f "${GITHUB_SHA}"
          fi
          git submodule update --init --recursive || true

      - name: 🟩 Install Node.js 20
        run: |
          set -euxo pipefail
          curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
          sudo apt-get install -y nodejs
          node -v
          npm -v

      - name: 📦 npm ci + build frontend
        run: |
          set -euxo pipefail
          npm ci
          npm run build

      - name: 🦀 Rust & Tauri CLI
        run: |
          set -euxo pipefail
          curl https://sh.rustup.rs -sSf | sh -s -- -y --profile minimal
          source "$HOME/.cargo/env"
          rustup target add aarch64-linux-android armv7-linux-androideabi
          cargo install tauri-cli --locked
          cargo tauri --version

      - name: 🤖 Android SDK/NDK
        run: |
          set -euxo pipefail
          sudo mkdir -p "$ANDROID_SDK_ROOT"
          sudo chown -R "$USER:$USER" "$ANDROID_SDK_ROOT"
          mkdir -p "$ANDROID_SDK_ROOT/cmdline-tools"
          cd "$ANDROID_SDK_ROOT/cmdline-tools"
          if [ ! -d "latest" ]; then
            curl -sSL https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip -o cmdline-tools.zip
            unzip -q cmdline-tools.zip
            mv cmdline-tools latest
            rm cmdline-tools.zip
          fi
          export PATH="$PATH:$ANDROID_SDK_ROOT/cmdline-tools/latest/bin"
          yes | sdkmanager --sdk_root="$ANDROID_SDK_ROOT" --licenses
          sdkmanager "platform-tools" "platforms;android-34" "build-tools;34.0.0" "ndk;25.2.9519653"

      - name: 🧩 Init Tauri Android (idempotent)
        run: |
          set -euxo pipefail
          source "$HOME/.cargo/env"
          if [ ! -d "src-tauri/gen/android" ]; then
            cargo tauri android init || true
          fi

      - name: 🧪 Build Debug APK
        run: |
          set -euxo pipefail
          source "$HOME/.cargo/env"
          cargo tauri android build --debug

      - name: 🔐 Build Release APK (signed on tag)
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          set -euxo pipefail
          source "$HOME/.cargo/env"
          keytool -genkeypair -v -keystore release-key.jks -keyalg RSA -keysize 2048 -validity 10000 \
            -storepass android -keypass android -dname "CN=OPNManager, OU=Dev, O=Dev, L=City, ST=State, C=US" \
            -alias opnmanager
          cargo tauri android build --release -- \
            --signing-key release-key.jks \
            --alias opnmanager \
            --storepass android \
            --keypass android
          APK_DIR="src-tauri/gen/android/app/build/outputs/apk/release"
          APK_FILE=$(ls "$APK_DIR"/*.apk | head -n 1)
          NEW_NAME="OPNManager-${GITHUB_REF_NAME}-release.apk"
          mv "$APK_FILE" "$APK_DIR/$NEW_NAME"
          echo "APK_RELEASE=$APK_DIR/$NEW_NAME" >> $GITHUB_ENV

      - name: 🚀 Upload to GitHub Release (gh)
        if: startsWith(github.ref, 'refs/tags/')
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euxo pipefail
          if ! command -v gh >/dev/null 2>&1; then
            echo "Installing GitHub CLI..."
            type -p curl >/dev/null || (sudo apt-get update && sudo apt-get install -y curl)
            curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
            sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
            sudo apt-get update && sudo apt-get install -y gh
          fi
          if ! gh release view "${GITHUB_REF_NAME}"; then
            gh release create "${GITHUB_REF_NAME}" "${APK_RELEASE}" --title "OPNManager ${GITHUB_REF_NAME}" --notes "Automated Android release"
          else
            gh release upload "${GITHUB_REF_NAME}" "${APK_RELEASE}" --clobber
          fi

      - name: 📄 Show APK paths
        run: |
          echo "Debug APK(s):"
          find src-tauri/gen/android/app/build/outputs/apk/debug -maxdepth 1 -name "*.apk" -type f || true
          echo "Release APK:"
          echo "${APK_RELEASE:-(not built because this was not a tag push)}"